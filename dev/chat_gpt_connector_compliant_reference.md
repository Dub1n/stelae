# ChatGPT Connector Compliance Reference (Stelae)

## 1. Purpose and Scope

- Capture all known requirements and observed behaviors necessary for Stelae’s public MCP endpoint to pass ChatGPT connector verification.
- Consolidate official specifications, internal design notes, community findings, and example implementations.
- Record the current state of the Stelae proxy to guide remediation and regression checks.

## 2. Primary References

| Type | Source | Notes |
| --- | --- | --- |
| Official MCP Spec | [modelcontextprotocol.io/introduction](https://modelcontextprotocol.io/introduction) | Protocol-level expectations for manifest discovery, SSE, and JSON-RPC. |
| OpenAI tooling docs | docs/openai-tools-connectors-mcp.md | Official guidance on connectors and remote MCP servers. |
| Internal compliance draft | docs/chat_gpt_connector_compliance_requirements_spec_v_0.md | Our detailed checklist (SSE heartbeats, initialize contract, HTTP semantics). |
| FastMCP README | docs/fastmcp-README.md | Describes default FastMCP responses (used by multiple compliant connectors). |
| Community forum notes | *How to set up a remote MCP server and connect it to ChatGPT* (OpenAI forums, 2024–2025) | Users report ChatGPT verifier expecting `search` + `fetch`. |
| Example connector | [todoist-mcp-connector](https://github.com/Alexislovesarchitecture/todoist-mcp-connector) | Minimal Streamable-HTTP server proven to pass ChatGPT verification. |
| Stelae probe output | `/tmp/probe.log` (generated by `dev/debug/chatgpt_connector_probe.py`) | Empirical timings and payloads from our endpoint. |
| Stelae proxy source | `/home/gabri/apps/mcp-proxy/http.go`, `/home/gabri/apps/mcp-proxy/response_helpers.go` | Manifest + initialize behavior. |
| Public manifest | https://mcp.infotopology.xyz/.well-known/mcp/manifest.json | Current edge-visible manifest. |

## 3. Compliance Requirements Catalogue

### 3.1 Discovery & Manifest (Official + Internal)

- **Requirement**: Serve JSON manifest at `/.well-known/mcp/manifest.json` containing name, endpoint URL, tools, prompts, resources (`docs/chat_gpt_connector_compliance_requirements_spec_v_0.md:18-22`).
- **ChatGPT nuance**: Community reports and working connectors publish *only* `search` and `fetch` tools to avoid moderation failure.
- **Stelae status**: Cloudflare worker normalizes manifest to list only `search` and `fetch` (see `cloudflare/worker/manifest-worker.js:25-107`).

### 3.2 SSE Endpoint (GET /mcp)

- **Requirement**: Respond with `Content-Type: text/event-stream`, send initial heartbeat/comment within 3–5 s, continue heartbeats ≤20 s (`docs/chat_gpt_connector_compliance_requirements_spec_v_0.md:34-47`).
- **Observed behavior**: Probe shows stream opening in ~0.14 s, immediate `event: endpoint` emission (`/tmp/probe.log`, first lines).
- **Notes**: Heartbeat cadence currently 15 s via Go ticker.

### 3.3 JSON-RPC POST /mcp

- **Requirement**: Accept JSON-RPC 2.0, handle `initialize`, `tools/list`, tool invocations, and return errors via JSON-RPC `error` while keeping HTTP 200 (`docs/chat_gpt_connector_compliance_requirements_spec_v_0.md:48-66`).
- **ChatGPT nuance (community)**: Verifier expects `initialize.result.tools` to contain `search` and `fetch` (matching manifest). Additional tool names have triggered moderation/timeouts for others.

### 3.4 Tool Naming & Shape (Community + Example)

- **Observed**: todoist-mcp-connector exports exactly two SSE routes:

  ```python
  Tool(name="search", ... output_model=SearchOutput, transport="sse")
  Tool(name="fetch",  ... output_model=FetchOutput, transport="sse")
  ```

  (todoist_mcp.py:161-180)
- **Response format**:
  - `search` returns array of `{id,title,text,url}` objects (`SearchOutput` model).
  - `fetch` returns `{id,title,text,url,metadata}` (`FetchOutput`).
- **Implication**: Initialization and `tools/list` responses must include schema describing these exact structures.

### 3.5 Head Request

- **Requirement**: `HEAD /mcp` must return 200 with SSE headers (internal spec §1.2).
- **Status**: Implemented in Go proxy (`http.go`: HEAD handler writes SSE headers and 200).

### 3.6 Error & Transport Semantics

- Keep HTTP 200 for protocol errors, avoid redirects, and ensure Cloudflare doesn’t emit 530/5xx except for genuine outages (internal spec §2, §4).
- Proxy already implements these patterns; log review shows `POST` responses stay at HTTP 200 with JSON-RPC errors when applicable.

## 4. Example Connector Behavior Summary (Todoist)

| Step | Request | Response | Notes |
| --- | --- | --- | --- |
| Manifest | N/A (not used for Deep Research) | Tools implicit through SSE endpoints | ChatGPT uses hard-coded endpoint. |
| SSE `GET /sse` | Accept text/event-stream, immediate `event: endpoint` with session (FastMCP default). | Requires heartbeats. | |
| `initialize` | JSON-RPC 2.0 | FastMCP returns `serverInfo`, `protocolVersion`, **exact tools list** (search/fetch) and optional prompts/resources. | |
| `tools/list` | JSON-RPC 2.0 | Mirrors initialize’s tool catalog. | |
| `tools/call search` | POST to SSE endpoint | Array of Todoist SearchHit objects. | |
| `tools/call fetch` | POST to SSE endpoint | Single Todoist FetchOutput object. | |

These responses are sufficient for ChatGPT verification and actual use (source: repo README + code inspect).

## 5. Stelae Current Behavior Snapshot (2025‑09‑28)

- **Manifest**: `curl https://mcp.infotopology.xyz/.well-known/mcp/manifest.json` → only `search`, `fetch` (post Cloudflare worker rewrite).
- **SSE**: `curl -Ns https://mcp.infotopology.xyz/mcp` → comment heartbeat and `event: endpoint` immediately (verified via probe).
- **Initialize**: Local proxy build trims `result.tools` to the facade descriptors (`search`, `fetch`). Production endpoint still returns the full upstream catalog until the proxy is redeployed.
- **tools/list**: Mirrors initialize in local tests (only `search`/`fetch`); production remains unfiltered for the moment.
- **Tool execution**: The Go facade now returns deterministic sample hits for `search`; `fetch` continues proxying Basic Memory/Docy responses.

## 6. Compliance Matrix

| Criterion | Source | Required Response (`y`) | Stelae Response (`y*`) | Status |
| --- | --- | --- | --- | --- |
| Manifest endpoint with search/fetch only | Community & manifest worker | JSON with `tools: [search, fetch]` | ✅ (Cloudflare worker) | ✅ |
| SSE GET heartbeat + endpoint event | Official + internal | `event: endpoint` + heartbeats | ✅ | ✅ |
| HEAD /mcp returns 200 SSE headers | Internal spec | SSE headers, no body | ✅ | ✅ |
| JSON-RPC `initialize` limited to search/fetch | Example connectors, community reports | `result.tools` = search, fetch | Local build returns search/fetch; production still reports full catalog until proxy redeploy | ⚠ (needs deploy) |
| JSON-RPC `tools/list` limited to search/fetch | Example connectors | same as initialize | Local build mirrors search/fetch; production still returns 40 tools pre-redeploy | ⚠ (needs deploy) |
| Tool schemas match ChatGPT expectation | Example (Todoist) | search → list of hits; fetch → document payload | search facade returns deterministic sample hits; fetch proxies upstream | ✅ (local static results) |
| HTTP error handling | Internal spec | 200 + JSON-RPC error | Matches | ✅ |
| SSE keepalive ≤20 s | Internal spec | heartbeat ≤20 s | 15 s ticker | ✅ |
| No redirects / TLS enforced | Internal spec | direct HTTPS | ✅ | ✅ |

## 7. Action Items

1. **Trim initialize/tools.list output**: Implemented via `collectTools` + `mergeWithFacadeDefaults`, exercised by `TestCollectToolsFiltersToFacadeCatalog`/`TestCollectToolsProvidesFacadeFallbacks`. Pending: redeploy proxy so production matches local results.
2. **Enhance mock search results**: Go facade now serves deterministic hits from `buildFacadeSearchPayload` and the Python streamable shim defaults to `STATIC_SEARCH_HITS`.
3. **Automate handshake validation**: `make check-connector` wraps `dev/debug/check_connector.py` to run the probe, assert tool catalogs/search hits, and write timestamped logs under `dev/logs/`.
4. **Coordinate with OpenAI**: Once production outputs align with the trimmed catalogs, share sanitized payloads + session IDs with support.

## 8. Appendix: Useful Commands & Snippets

```bash
# Generate manifest snapshot
curl -s https://mcp.infotopology.xyz/.well-known/mcp/manifest.json | jq

# Run local probe (requires httpx in ~/.venvs/stelae-bridge)
~/.venvs/stelae-bridge/bin/python dev/debug/chatgpt_connector_probe.py > /tmp/probe.log

# Automated validation + log archive
make check-connector

# Inspect initialize tools in probe output
rg '"'"'"tools": \['"'"' /tmp/probe.log -n

# Key source locations
/home/gabri/apps/mcp-proxy/http.go
/home/gabri/apps/mcp-proxy/response_helpers.go
cloudflare/worker/manifest-worker.js
```

```go
// response_helpers.go: buildInitializeResult excerpt
result := map[string]any{
    "protocolVersion": "2024-11-05",
    "serverInfo":      serverInfo,
    "capabilities":    capabilities,
    "tools":           tools,
}
```

```python
# todoist-mcp-connector: Tool definitions
Tool(
    name="search",
    description="Search Todoist tasks and projects by free-text query",
    ...,
    transport="sse",
),
Tool(
    name="fetch",
    description="Fetch full details for a Todoist task or project",
    ...,
    transport="sse",
)
```

*Maintainer:* Stelae Infra. Update this document whenever the OpenAI verifier behavior or protocol requirements evolve.
