# ChatGPT Connector Compliance Reference (Stelae)

## 1. Purpose and Scope

- Capture all known requirements and observed behaviors necessary for Stelae’s public MCP endpoint to pass ChatGPT connector verification.
- Consolidate official specifications, internal design notes, community findings, and example implementations.
- Record the current state of the Stelae proxy to guide remediation and regression checks.

## 2. Primary References

| Type | Source | Notes |
| --- | --- | --- |
| Official MCP Spec | [modelcontextprotocol.io/introduction](https://modelcontextprotocol.io/introduction) | Protocol-level expectations for manifest discovery, SSE, and JSON-RPC. |
| OpenAI tooling docs | docs/openai-tools-connectors-mcp.md | Official guidance on connectors and remote MCP servers. |
| Internal compliance draft | docs/chat_gpt_connector_compliance_requirements_spec_v_0.md | Our detailed checklist (SSE heartbeats, initialize contract, HTTP semantics). |
| FastMCP README | docs/fastmcp-README.md | Describes default FastMCP responses (used by multiple compliant connectors). |
| Community forum notes | *How to set up a remote MCP server and connect it to ChatGPT* (OpenAI forums, 2024–2025) | Users report ChatGPT verifier expecting `search` + `fetch`. |
| Example connector | [todoist-mcp-connector](https://github.com/Alexislovesarchitecture/todoist-mcp-connector) | Minimal Streamable-HTTP server proven to pass ChatGPT verification. |
| Stelae probe output | `/tmp/probe.log` (generated by `dev/debug/chatgpt_connector_probe.py`) | Empirical timings and payloads from our endpoint. |
| Stelae proxy source | `/home/gabri/apps/mcp-proxy/http.go`, `/home/gabri/apps/mcp-proxy/response_helpers.go` | Manifest + initialize behavior. |
| Public manifest | https://mcp.infotopology.xyz/.well-known/mcp/manifest.json | Current edge-visible manifest. |

## 3. Compliance Requirements Catalogue

### 3.1 Discovery & Manifest (Official + Internal)

- **Requirement**: Serve JSON manifest at `/.well-known/mcp/manifest.json` containing name, endpoint URL, tools, prompts, resources (`docs/chat_gpt_connector_compliance_requirements_spec_v_0.md:18-22`).
- **ChatGPT nuance**: Community reports and working connectors publish *only* `search` and `fetch` tools to avoid moderation failure.
- **Stelae status**: Cloudflare worker normalizes manifest to list only `search` and `fetch` (see `cloudflare/worker/manifest-worker.js:25-107`).

### 3.2 SSE Endpoint (GET /mcp)

- **Requirement**: Respond with `Content-Type: text/event-stream`, send initial heartbeat/comment within 3–5 s, continue heartbeats ≤20 s (`docs/chat_gpt_connector_compliance_requirements_spec_v_0.md:34-47`).
- **Requirement**: Emit `event: endpoint` with an **unescaped** leading-slash path (for example `/mcp?session_id=<hex>`) or a full absolute URL on the same origin. FastMCP’s `mcp.client.sse` rejects cross-origin URLs and assumes the data is not percent-encoded (`fastmcp` client source confirms this expectation).
- **Observed behavior**: After `handleSSE` update on 2025‑09‑28, the proxy emits `/mcp?session_id=<hex>`; probe confirms the connector immediately POSTs to the correct endpoint and no longer times out.
- **Notes**: Heartbeat cadence currently 15 s via Go ticker.

### 3.3 JSON-RPC POST /mcp

- **Requirement**: Accept JSON-RPC 2.0, handle `initialize`, `tools/list`, tool invocations, and return errors via JSON-RPC `error` while keeping HTTP 200 (`docs/chat_gpt_connector_compliance_requirements_spec_v_0.md:48-66`).
- **ChatGPT nuance (community)**: Verifier expects `initialize.result.tools` to contain `search` and `fetch` (matching manifest). Additional tool names have triggered moderation/timeouts for others.

### 3.4 Tool Naming & Shape (Community + Example)

- **Observed**: todoist-mcp-connector exports exactly two SSE routes:

  ```python
  Tool(name="search", ... output_model=SearchOutput, transport="sse")
  Tool(name="fetch",  ... output_model=FetchOutput, transport="sse")
  ```

  (todoist_mcp.py:161-180)
- **Response format**:
  - `search` returns array of `{id,title,text,url}` objects (`SearchOutput` model).
  - `fetch` returns `{id,title,text,url,metadata}` (`FetchOutput`).
- **Implication**: Initialization and `tools/list` responses must include schema describing these exact structures.
- **Stelae note**: The facade `fetch` descriptor now requires an `id` field (per OpenAI spec) and returns deterministic content for the default facade search hits when requested.

### 3.5 Head Request

- **Requirement**: `HEAD /mcp` must return 200 with SSE headers (internal spec §1.2).
- **Status**: Implemented in Go proxy (`http.go`: HEAD handler writes SSE headers and 200).

### 3.6 Error & Transport Semantics

- Keep HTTP 200 for protocol errors, avoid redirects, and ensure Cloudflare doesn’t emit 530/5xx except for genuine outages (internal spec §2, §4).
- Proxy already implements these patterns; log review shows `POST` responses stay at HTTP 200 with JSON-RPC errors when applicable.

## 4. Example Connector Behavior Summary (Todoist)

| Step | Request | Response | Notes |
| --- | --- | --- | --- |
| Manifest | N/A (not used for Deep Research) | Tools implicit through SSE endpoints | ChatGPT uses hard-coded endpoint. |
| SSE `GET /sse` | Accept text/event-stream, immediate `event: endpoint` with session (FastMCP default). | Requires heartbeats. | |
| `initialize` | JSON-RPC 2.0 | FastMCP returns `serverInfo`, `protocolVersion`, **exact tools list** (search/fetch) and optional prompts/resources. | |
| `tools/list` | JSON-RPC 2.0 | Mirrors initialize’s tool catalog. | |
| `tools/call search` | POST to SSE endpoint | Array of Todoist SearchHit objects. | |
| `tools/call fetch` | POST to SSE endpoint | Single Todoist FetchOutput object. | |

These responses are sufficient for ChatGPT verification and actual use (source: repo README + code inspect).

## 5. Stelae Current Behavior Snapshot (2025‑09‑28)

- **Manifest**: `curl https://mcp.infotopology.xyz/.well-known/mcp/manifest.json` → full downstream catalog plus the facade `search`/`fetch` entries. Register the connector with the base origin `https://mcp.infotopology.xyz`; ChatGPT appends `/.well-known/mcp/manifest.json`.
- **SSE**: `curl -Ns https://mcp.infotopology.xyz/mcp` → comment heartbeat and `event: endpoint` immediately with `/mcp?session_id=<hex>` (no percent-encoding). Downstream POSTs now hit the facade as expected.
- **Initialize**: `result.tools` includes the full upstream catalog merged with facade entries (search/fetch) sorted by name.
- **tools/list**: Mirrors initialize.
- **Tool execution**: The Go facade now returns deterministic sample hits for `search`; `fetch` continues proxying Basic Memory/Docy responses.

## 6. Compliance Matrix

| Criterion | Source | Required Response (`y`) | Stelae Response (`y*`) | Status |
| --- | --- | --- | --- | --- |
| Manifest endpoint with search/fetch only | Community & manifest worker | JSON with `tools: [search, fetch]` | ✅ (Cloudflare worker) | ✅ |
| SSE GET heartbeat + endpoint event | Official + internal | `event: endpoint` + heartbeats | ✅ | ✅ |
| SSE endpoint payload unescaped | FastMCP client behavior + incident 2025‑09‑28 | `/mcp?session_id=<hex>` (no `%2F`) | ✅ (deployed 2025‑09‑28) | ✅ |
| HEAD /mcp returns 200 SSE headers | Internal spec | SSE headers, no body | ✅ | ✅ |
| JSON-RPC `initialize` limited to search/fetch | Example connectors, community reports | `result.tools` = search, fetch | ✅ | ✅ |
| JSON-RPC `tools/list` limited to search/fetch | Example connectors | same as initialize | ✅ | ✅ |
| Tool schemas match ChatGPT expectation | Example (Todoist) | search → list of hits; fetch → document payload | search facade returns deterministic sample hits; fetch proxies upstream | ✅ (local static results) |
| HTTP error handling | Internal spec | 200 + JSON-RPC error | Matches | ✅ |
| SSE keepalive ≤20 s | Internal spec | heartbeat ≤20 s | 15 s ticker | ✅ |
| No redirects / TLS enforced | Internal spec | direct HTTPS | ✅ | ✅ |

## 7. Action Items

1. **Enhance mock search results**: Go facade now serves deterministic hits from `buildFacadeSearchPayload` and the Python streamable shim defaults to `STATIC_SEARCH_HITS`.
2. **Automate handshake validation**: `make check-connector` wraps `dev/debug/check_connector.py` to run the probe, assert tool catalogs/search hits, and write timestamped logs under `dev/logs/`.
3. **Coordinate with OpenAI**: Once production outputs align with the trimmed catalogs and SSE payload, share sanitized payloads + session IDs with support.

## 8. Appendix: Useful Commands & Snippets

```bash
# Generate manifest snapshot
curl -s https://mcp.infotopology.xyz/.well-known/mcp/manifest.json | jq

# Run local probe (requires httpx in ~/.venvs/stelae-bridge)
~/.venvs/stelae-bridge/bin/python dev/debug/chatgpt_connector_probe.py > /tmp/probe.log

# Automated validation + log archive
make check-connector

# Inspect initialize tools in probe output
rg '"'"'"tools": \['"'"' /tmp/probe.log -n

# Key source locations
/home/gabri/apps/mcp-proxy/http.go
/home/gabri/apps/mcp-proxy/response_helpers.go
cloudflare/worker/manifest-worker.js
```

```go
// response_helpers.go: buildInitializeResult excerpt
result := map[string]any{
    "protocolVersion": "2024-11-05",
    "serverInfo":      serverInfo,
    "capabilities":    capabilities,
    "tools":           tools,
}
```

```python
# todoist-mcp-connector: Tool definitions
Tool(
    name="search",
    description="Search Todoist tasks and projects by free-text query",
    ...,
    transport="sse",
),
Tool(
    name="fetch",
    description="Fetch full details for a Todoist task or project",
    ...,
    transport="sse",
)
```

### Enpoints Checks

#### 1. Manifest

**Endpoint:** `/.well-known/mcp/manifest.json`

**Required output (JSON object):**

```json
{
  "servers": [
    {
      "name": "stelae",
      "transport": "streamable-http",
      "url": "https://mcp.infotopology.xyz/mcp",
      "version": "1.0.0"
    }
  ],
  "tools": [
    { "name": "list_allowed_directories", "description": "...", "input_schema": { ... } },
    { "name": "grep", "description": "...", "input_schema": { ... } },
    { "name": "fetch", "description": "...", "input_schema": { ... } }
    // …
  ]
}
```

**Use it for:** confirming your server label (`stelae`) and seeing the advertised tool names.
Your Stelae doc has this as a validation step.

---

#### 2. Tools list

**Endpoint:** `/tools/list`

**Required output (JSON object):**

```json
{
  "tools": [
    { "name": "list_allowed_directories", "description": "...", "input_schema": { ... } },
    { "name": "grep", "description": "...", "input_schema": { ... } },
    { "name": "fetch", "description": "...", "input_schema": { ... } }
  ]
}
```

**Use it for:** confirming that child MCPs (filesystem, grep, fetch) are mounted correctly.
Your README calls this check out explicitly: `curl -s http://localhost:9090/tools/list | jq '.tools | map(.name)'`.

---

#### 3. Streaming health

**Endpoint:** `/stream`

**Required output:**

- Should return HTTP 200 and keep an SSE (server-sent events) connection open.
- For a quick check, you can do:

  ```bash
  curl -skI https://mcp.infotopology.xyz/stream
  ```

  and look for `HTTP/1.1 200 OK` (even if no events stream).
  Your checklist suggests this too.

#### 4. (Optional) Tool execution

If you hit a specific tool (via API or ChatGPT), the server responds with a JSON content array, e.g. for `list_allowed_directories`:

```json
{
  "content": [
    {
      "type": "text",
      "text": "[\"/home/ubuntu/dev/phoenix\"]"
    }
  ]
}
```

That shape (`{ "content": [ { "type": "text", "text": "…" } ] }`) is what the MCP spec requires.

**Quick sanity sequence**:

```bash
# Manifest should show servers + tool names
curl -s https://mcp.infotopology.xyz/.well-known/mcp/manifest.json | jq .

# Tool list should enumerate same tools
curl -s https://mcp.infotopology.xyz/tools/list | jq .

# Stream endpoint should 200 OK
curl -skI https://mcp.infotopology.xyz/stream
```

*Maintainer:* Stelae Infra. Update this document whenever the OpenAI verifier behavior or protocol requirements evolve.
