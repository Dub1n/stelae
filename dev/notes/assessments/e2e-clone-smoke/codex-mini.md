# Stelae MCP: Clone Smoke Test Recovery, Catalog Hygiene, and Doc Consolidation — codex-mini Assessment (2025-11-13)

## Context

- The repo now relies on the Codex-driven e2e clone smoke test (see `docs/e2e_clone_smoke_test.md`) both as verification and as regression coverage for the self-managing stack. The harness clones into a disposable workspace, installs the starter bundle, re-renders configs, and drives codex exec stages that call `workspace_fs_read`, `doc_fetch_suite`, and the aggregate `manage_stelae` tool before cleaning up.
- Tool aggregation is the mechanism that keeps the manifest clean: `config/tool_aggregations.json` tracks only the repo-owned wrappers while `${STELAE_CONFIG_HOME}/config/tool_aggregations.local.json` stores optional bundles, and `scripts/process_tool_aggregations.py --scope local` writes runtime overrides into `${TOOL_OVERRIDES_PATH}` so local-only tools show up as aggregates without contaminating tracked templates (`README.md:121`, `docs/ARCHITECTURE.md:91`).

## Key Findings

1. **Catalog hygiene is now enforced by separate overlays.** The local scope (`overlay_only=True`) no longer bakes third-party tools into the tracked defaults, so renders keep the repository clean while the starter bundle still exposes `workspace_fs_*`, `doc_fetch_suite`, etc. The README/architecture docs call this out explicitly, echoing the new script behavior. A default-scope pass (`--scope default`) exists for intentional changes to `config/tool_overrides.json`.
2. **Aggregations require dedup + pass-through handling.** Recent work (commit `project: stelae aggregation visibility fix`) deduplicates `enum`/`required` arrays inside `ToolOverridesStore`, preventing Codex from rejecting the manifest (`Invalid schema ... non-unique`). The aggregator server now uses `PassthroughFuncMetadata` so aggregated tools accept their arguments directly (no nested `arguments` object) and the aggregator runner logs/observability (plus the new environment variables such as `STELAE_TOOL_AGGREGATOR_DEBUG_TOOLS` in `stelae_lib/integrator/tool_aggregations.py`) capture payload/response snapshots when debugging is enabled. This resolves the last known manifest blocker for the `codex exec` trials (`dev/tasks/stelae-mcp-catalog-consistency.md`).
3. **Streamable bridge debugging got richer.** `scripts/stelae_streamable_mcp.py` now logs invalid JSON payloads, flushes tool-call snapshots to `logs/streamable_tool_debug.log`, and exposes `STELAE_STREAMABLE_DEBUG_TOOLS`/`STELAE_STREAMABLE_DEBUG_TOOL_PREVIEW` so we can follow what each pipeline sees when agents fail to parse responses. This is directly relevant to the ongoing `Expecting value` failures from `workspace_fs_read` captu` (dev/tasks/stelae-mcp-catalog-consistency.md, follow-up items).
4. **Codex harness is fully documented but still sensitive.** The `docs/e2e_clone_smoke_test.md` and `dev/tasks/clone-smoke-harness-stability.md` workbooks make the sequence explicit (clone → render → restart → Codex stages → pytest/verify clean) along with manual stage helpers. They highlight the remaining traps: long-running restarts that time out (even with `timeout 1200s`) and pm2 permission collisions when the sandbox tries to inspect the developer’s ongoing stack.

## Open Issues

1. **Codex still sees `Expecting value` for `workspace_fs_read`.** Post-dedupe trials (`logs/codex-catalog-trial-tools-v4` → `-v7`) still fail in stage 1 with JSON parsing errors even though raw HTTP calls succeed. The manifest indicates the request completes, so the bridge (or Codex’s adapter) is trying to parse a textual response as JSON. The docs now list this as a follow-up (point 4 in `dev/tasks/stelae-mcp-catalog-consistency.md`), and the new debug paths in `scripts/stelae_streamable_mcp.py` should help capture what the bridge actually hands back.
2. **The harness restart loop still exceeds practical timeouts.** Even after wiring `PROXY_PORT` into `.env.example`, `config/proxy.template.json`, and the restart path, `scripts/run_e2e_clone_smoke_test.py --manual-stage install` timed out at 120 s, 300 s, and even 1200 s while `scripts/run_restart_stelae.sh` waited on readiness (`Local probe: HEAD …` never emits). The docs note the harness hits these walls before reaching the codex stages, so we still need a way to signal readiness without relying on long `timeout`, or to split the workflow into smaller, resumable chunks that verify pm2 readiness before continuing.
3. **`codex-wrapper-dev.batch` orchestrator still cannot inspect pm2.** The orchestrator mission (`logs/codex-catalog-orchestrator-*.jsonl`) can't touch `/home/gabri/.pm2/{interactor,rpc}.sock`, so it cannot run the Health check. This means orchestration trials still rely on human prompts until we either grant the wrapper socket access or add a different readiness probe.

## Recommendations

1. **Instrument the streamable bridge’s outgoing payloads.** Enable `STELAE_STREAMABLE_DEBUG_TOOLS=workspace_fs_read` (or `*`) and examine `logs/streamable_tool_debug.log` to confirm the JSON that reaches Codex. If the JSON is valid, add logging inside the Codex adapter to see what `mcp__stelae__workspace_fs_read` returns to the agent; the new logging inside `stelae_lib/integrator/tool_aggregations.py` can track the aggregated tool’s arguments/responses as well.
2. **Break the harness restart/watchdog path into smaller checkpoints.** Align `scripts/run_restart_stelae.sh` with `timeout` proxies: exit once the proxy responds to `/mcp` and we’ve populated overrides; allow the harness to `--manual-stage bundle-tools` to avoid repeated restarts, or add a `--skip-readiness` flag for manual verification. The live workbook (`dev/tasks/clone-smoke-harness-stability.md`) should also record each run’s port, pm2 log, and failure step so we can spot when timeouts recur.
3. **Merge the dispersed docs into a cohesive playbook.** Combine the scattered task.notes into a single `dev/tasks/e2e_clone_smoke_plan.md` (or similar) that links `docs/e2e_clone_smoke_test.md`, `dev/tasks/clone-smoke-harness-stability.md`, `dev/tasks/codex-manage-stelae-smoke.md`, and `dev/tasks/stelae-mcp-catalog-consistency.md`. That document can enumerate the intended flow, the outstanding blockers, and which log files to inspect so future work doesn’t reintroduce regressions.
4. **Re-run catalog trials once the bridge issue is resolved, then update docs.** Capture transcripts for both the tester (`codex exec --json`) and orchestrator (`codex-wrapper-dev.batch`) and store them under `logs/`. Afterwards, mark `stelae-mcp-catalog-consistency` as resolved, update `dev/progress.md`, and ensure the smoke harness asserts the new success path.

## References

- `README.md`, `docs/ARCHITECTURE.md`, and `scripts/process_tool_aggregations.py` describe the clean separation between tracked defaults and local overlays plus the new dedupe logic.
- `docs/e2e_clone_smoke_test.md` and `dev/tasks/clone-smoke-harness-stability.md` document the harness stages, timeouts, and manual playbook options.
- `dev/tasks/stelae-mcp-catalog-consistency.md` lists the pending JSON-parsing bug, orchestrator pm2 issues, and doc updates that still need closing.
- `scripts/stelae_streamable_mcp.py` and `stelae_lib/integrator/tool_aggregations.py` now expose debug logging for tool payloads, which will be the main instrumentation for the next troubleshooting round.
